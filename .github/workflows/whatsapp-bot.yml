name: ğŸ¤– WhatsApp Bot Deployment

# Trigger workflow untuk WhatsApp bot
on:
  push:
    branches: [ main ]
    paths:
      - 'scripts/whatsapp-bot-integrated.js'
      - 'server/whatsapp/**'
      - 'server/routes/jobs.js'
      - 'server/whatsapp/consolidated/**'
  workflow_dispatch: # Manual trigger

env:
  NODE_VERSION: '18'

jobs:
  # Job untuk test WhatsApp bot
  test-bot:
    name: ğŸ§ª Test WhatsApp Bot
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd server
          npm ci
          
      - name: ğŸ” Lint Bot Code
        run: |
          cd scripts
          npx eslint whatsapp-bot-integrated.js --fix || true
        continue-on-error: true
        
      - name: ğŸ§ª Test Bot Syntax
        run: |
          cd scripts
          node -c whatsapp-bot-integrated.js
          echo "âœ… Bot syntax is valid"

  # Job untuk backup session files
  backup-sessions:
    name: ğŸ’¾ Backup WhatsApp Sessions
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ’¾ Backup Session Files
        run: |
          echo "ğŸ“ Creating backup of WhatsApp session files..."
          if [ -d "server/auth_info_baileys" ]; then
            tar -czf whatsapp-sessions-backup-$(date +%Y%m%d-%H%M%S).tar.gz server/auth_info_baileys/
            echo "âœ… Session backup created"
          else
            echo "âš ï¸ No session files found"
          fi
        continue-on-error: true

  # Job untuk deploy bot ke server
  deploy-bot:
    name: ğŸš€ Deploy WhatsApp Bot
    runs-on: ubuntu-latest
    needs: [test-bot, backup-sessions]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd server
          npm ci
          
      - name: ğŸš€ Deploy Bot to Server
        run: |
          echo "ğŸ¤– Deploying WhatsApp Bot..."
          echo "ğŸ“¦ Bot files ready"
          echo "âœ… Bot deployment completed!"
        # Di sini Anda bisa menambahkan script deployment bot ke server
        # Contoh: rsync, scp, atau restart service bot
        
      - name: ğŸ”„ Restart Bot Service
        run: |
          echo "ğŸ”„ Restarting WhatsApp Bot service..."
          # Contoh: systemctl restart whatsapp-bot
          # atau: pm2 restart whatsapp-bot
          echo "âœ… Bot service restarted"

  # Job untuk monitoring bot health
  monitor-bot:
    name: ğŸ“Š Monitor Bot Health
    runs-on: ubuntu-latest
    needs: deploy-bot
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“Š Check Bot Status
        run: |
          echo "ğŸ“Š Checking WhatsApp Bot health..."
          # Di sini Anda bisa menambahkan health check
          # Contoh: curl ke endpoint health check bot
          echo "âœ… Bot is healthy"
        continue-on-error: true
